<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Red Green - Files browsing test</title>
        <script type="text/javascript">
            window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;
            window.redGreen = {
                lastUsed: 'default',
                files: {}
            };
                        
            function errorHandler(e) {
                var msg = '';
                
                switch (e.code) {
                    case window.FileError.QUOTA_EXCEEDED_ERR:
                        msg = 'QUOTA_EXCEEDED_ERR';
                        break;
                    case window.FileError.NOT_FOUND_ERR:
                        msg = 'NOT_FOUND_ERR';
                        break;
                    case window.FileError.SECURITY_ERR:
                        msg = 'SECURITY_ERR';
                        break;
                    case window.FileError.INVALID_MODIFICATION_ERR:
                        msg = 'INVALID_MODIFICATION_ERR';
                        break;
                    case window.FileError.INVALID_STATE_ERR:
                        msg = 'INVALID_STATE_ERR';
                        break;
                    default:
                        msg = 'Unknown Error';
                        break;
                }
                
                console.log('Error: ' + msg);
                console.log(e);
            }
            
            function createDir(rootDirEntry, folders, successCallback) {
                // Throw out './' or '/' and move on to prevent something like '/foo/.//bar'.
                if (folders[0] === '.' || folders[0] === '') {
                    folders = folders.slice(1);
                }
                rootDirEntry.getDirectory(folders[0], {create: true}, function(dirEntry) {
                    // Recursively add the new subfolder (if we still have another to create).
                    if (folders.length) {
                        createDir(dirEntry, folders.slice(1), successCallback);
                    } else {
                        successCallback(dirEntry);
                    }
                }, errorHandler);
            }
           
            window.onload = function() {
                window.webkitStorageInfo.requestQuota(window.PERSISTENT, 1024*1024, 
                    function(grantedBytes) {
                        window.requestFileSystem(window.PERSISTENT, grantedBytes, function(fs) {
                            createDir(fs.root, 'red-green/logs'.split('/'), function(dir) {
                                var dirReader = dir.createReader();
                                                                
                                var readEntries = function() {
                                    dirReader.readEntries (function(files) {
                                        if (files.length) {
                                            console.log(files);
                                            Array.prototype.forEach.call(files, function(file) {
                                                var parts,
                                                    fileName,
                                                    number;
                                                
                                                if (/(.*)-(\d+)\.txt$/.test(file.name)) {
                                                    parts = file.name.match(/(.*)-(\d+)\.txt$/);
                                                    fileName = parts[1];
                                                    number = parseInt(parts[2], 10);
                                                    
                                                    if (window.redGreen.files.hasOwnProperty(fileName)) {
                                                        if (number > window.redGreen.files[fileName]) {
                                                            window.redGreen.files[fileName] = number;
                                                        }
                                                    } else {
                                                        window.redGreen.files[fileName] = number;
                                                    }
                                                }
                                            });
                                            readEntries();
                                        }
                                    }, errorHandler);
                                };
                                
                                readEntries();
                            });
                        });
                    }, function(e) {
                        console.log('Error', e);
                    }
                );                
            };
            
            function start() {
                var fileName = window.redGreen.lastUsed;
                var number; 
                if (window.redGreen.files.hasOwnProperty(fileName)) {
                    number = window.redGreen.files[fileName] + 1;
                } else {
                    number = 0;
                }
                
                window.redGreen.files[fileName] = number;
                var fullName = fileName + '-' + number + '.txt';
                
                window.requestFileSystem(window.PERSISTENT, 0, function(fs) {
                    fs.root.getFile('red-green/logs/' + fullName, {create: true}, function(fileEntry) {
                        console.log(fileEntry);
                    });              
                });
            }
            
            function changeFileName() {
                var fileName = document.querySelector('#fileName').value;
                if (fileName && fileName.trim() !== "") {
                    window.redGreen.lastUsed = fileName;
                }
            }
        </script>
	</head>
	<body>
        <div>
            <input type="text" id="fileName"/>
            <button id="change" onclick="changeFileName();">Change</button>
        </div>
		<button id="start" onclick="start();">Start</button>
	</body>
</html>